import javafx.application.Application;
import javafx.stage.Stage;
import javafx.scene.Scene;
import javafx.scene.layout.*;
import javafx.scene.control.*;
import javafx.event.Event;
import javafx.scene.input.*;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.paint.Color;
import javafx.scene.shape.ArcType;

// ?A?N?V?????Q?[????v???O????
public class Sample4 extends Application{
	// ?L?????o?X????
	Canvas canvas = new Canvas(800,600);
	GraphicsContext gc = canvas.getGraphicsContext2D();
	// ?v???C???[?????
	Player player = new Player(400,600);	// ?v???C???[
	Buttai[] buttai = new Buttai[8];		// ?????????
	// ????????
	int score=0;					// ?X?R?A
	boolean rightPressing=false;	// ?E?L?[?????????????^?U?l
	boolean leftPressing=false;		// ???L?[?????????????^?U?l
	boolean spacePressing=false;	// ?X?y?[?X?????????????^?U?l
	// start???\?b?h
	public void start(Stage stage){
		// ????????????
		buttai[0] = new Buttai(0,550,6,0);
		buttai[1] = new Buttai(0,450,5,0);
		buttai[2] = new Buttai(700,550,-4,0);
		buttai[3] = new Buttai(700,450,-7,0);
		buttai[4] = new Buttai(600,400,6,0);
		buttai[5] = new Buttai(500,350,5,0);
		buttai[6] = new Buttai(400,250,-4,0);
		buttai[7] = new Buttai(300,150,-7,0);
		// ?}???`?X???b?h????s?i??`????j
		SystemThread th1 = new SystemThread();
		GraphicsThread th2 = new GraphicsThread();
		th1.start();
		th2.start();
		
		// pane1????i???g?p?A???R??g????????????j
		FlowPane pane1 = new FlowPane();
		
		// pane1??L?????o?X?????[?g?y?C????z?u
		VBox pane = new VBox();
		pane.getChildren().add(pane1);
		pane.getChildren().add(canvas);
		
		// ?L?[??C?x???g?n???h????o?^
		Scene scene = new Scene(pane);
		scene.setOnKeyTyped(event -> keyTyped(event));
		scene.setOnKeyPressed(event -> keyPressed(event));
		scene.setOnKeyReleased(event -> keyReleased(event));
		
		// ?E?B???h?E??\????
		stage.setOnCloseRequest(event -> System.exit(0));
		stage.setScene(scene);
		stage.setTitle("?A?N?V?????Q?[??");	//?^?C?g??????
		stage.sizeToScene();
		stage.show();
	}
	// ???????^?C?v????????s????��?\?b?h
	void keyTyped(KeyEvent event){
		String text = event.getCharacter();
		//System.out.print("?^?C?v?????????B");
		//System.out.println("\tString?F\t"+text);
	}
	// ?L?[????????????s????��?\?b?h
	void keyPressed(KeyEvent event){
		KeyCode key = event.getCode();
		//System.out.print("?L?[?????????????B");
		//System.out.println("\tKeyCode?F\t"+key);
		// ?????L?[??????????A???????^?U?l??true?????
		if(key==KeyCode.RIGHT){
			rightPressing=true;
		}else if(key==KeyCode.LEFT){
			leftPressing=true;
		}
		if(key==KeyCode.SPACE){
			spacePressing=true;
		}
	}
	// ?L?[????????????s????��?\?b?h
	void keyReleased(KeyEvent event){
		KeyCode key = event.getCode();
		//System.out.print("?L?[?????????????B");
		//System.out.println("\tKeyCode?F\t"+key);
		// ?????L?[??????????A???????^?U?l??true?????
		if(key==KeyCode.RIGHT){
			rightPressing=false;
		}else if(key==KeyCode.LEFT){
			leftPressing=false;
		}
		if(key==KeyCode.SPACE){
			spacePressing=false;
		}
	}
	// ?v???C???[?N???X
	class Player{
		double x,y;	// ??u???W
		int vy=0;	// y??????????x
		boolean jumping=false;	// ?W?????v???????????^?U?l
		Player(int x,int y){
			this.x = x;
			this.y = y;
		}
		// ???????
		void move(int x){
			this.x += x;	// x???W???X
			if(this.x >= canvas.getWidth()){
				this.x = 0;
			}
			if(this.x < 0){
				this.x = canvas.getWidth();
			}
		}
		// ?W?????v?J?n
		void jump(int y){
			this.y += y+vy;	// y???W???X
			vy+=1;			// y?????????
		}
		// ?v???C???[??`??
		void draw(){
			gc.setFill(Color.BLACK);
			gc.fillOval(x-20,y-80,40,80);
			}
	}
	// ??????????N???X
	class Buttai{
		int x,y;	// ??u???W
		int vx,vy;	// ???x
		boolean exists=true;	// ???????????????????????^?U?l
		Buttai(int x,int y,int vx,int vy){
			this.x = x;
			this.y = y;
			this.vx = vx;
			this.vy = vy;
		}
		// ???????
		void move(){
			this.x += vx;
			this.y += vy;
			if(score>10){
				this.x += vx*4;
				this.y += vy*4;
			}else if(score>30){
				this.x += vx*8;
				this.y += vy*8;
			}else if(score>50){
				this.x += vx*16;
				this.y += vy*16;
			}else if(score>70){
				this.x += vx*32;
				this.y += vy*32;
			}
		}
		// ?v???C???[??G?????????????^?U?l????
		boolean touched(){
			boolean b1 = x>=player.x-20;
			boolean b2 = x<=player.x+20;
			boolean b3 = y>=player.y-80;
			boolean b4 = y<=player.y;
			boolean b5 = x>=player.x-20;
			boolean b6 = x<=player.x+20;
			boolean b7 = y>=player.y-80;
			boolean b8 = y<=player.y;
			return b1 && b2 && b3 && b4 && b5 && b6 && b7 && b8;
		}
		// ?????`??
		void draw(){
			if(exists){
				gc.setFill(Color.RED);
				gc.fillOval(x-10,y-10,20,20);
			}
		}
	}
	// ?V?X?e?????X???b?h
	class SystemThread extends Thread{
		public void run(){
			while(true){
				try{
					Thread.sleep(1);
				}catch(InterruptedException e){}
				// ?W?????v?????A?n???????????W?????v?I??
				if(player.jumping && player.y>600){
					player.y=600;
					player.vy=0;
					player.jumping=false;
				}
				// ?n??????A?X?y?[?X???????????????E?E?E
				while(!player.jumping && !spacePressing){
					try{
						Thread.sleep(1);
					}catch(InterruptedException e){}
					// ?E?E?E?X?y?[?X??????????W?????v
					if(spacePressing){
						player.jumping=true;
					}
				}
			}
		}
	}
	// ?`???????X???b?h
	class GraphicsThread extends Thread{
		public void run(){
			while(true){
				// ?L?????o?X????Z?b?g
				gc.setFill(Color.WHITE);
				gc.fillRect(0,0,canvas.getWidth(),canvas.getHeight());
				// ???????L?[????????L?????N?^?[??`??
				if(rightPressing){
					player.move(10);
				}else if(leftPressing){
					player.move(-10);
				}
				if(player.jumping){
					player.jump(-28);
				}
				player.draw();
				// ??????????`??
				for(int i=0;i<buttai.length;i++){
					buttai[i].move();
					// ?[????B??????t??????o?????
					if(buttai[i].x<0){
						buttai[i].x=(int)canvas.getWidth();
						buttai[i].exists=true;	// ????????????
					}else if(buttai[i].x>canvas.getWidth()){
						buttai[i].x=0;
						buttai[i].exists=true;	// ????????????
					}
					buttai[i].draw();
					// ?v???C???[??G???????
					if(buttai[i].exists && buttai[i].touched()){
						buttai[i].exists = false;
						score+=1;
					}
				}
				// ?e???b?Z?[?W??`??
				gc.setFill(Color.BLACK);
				gc.fillText("???E?L?[?F???",100,100);
				gc.fillText("?X?y?[?X?L?[?F?W?????v",100,110);
				gc.fillText("score: "+score,400,100);
				// ?????~
				try{
					Thread.sleep(20);
				}catch(InterruptedException e){}
			}
		}
	}
	// main???\?b?h
	public static void main(String args[]){
		launch();
	}
}
